<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ghosts Gambling</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        :root { --bg-color: #121212; --primary-color: #1a1a1a; --secondary-color: #252525; --text-color: #e0e0e0; --accent-color: #ffffff; --border-radius: 8px; --shadow: 0 4px 15px rgba(0, 0, 0, 0.4); --safe-color: #2ecc71; --mine-color: #e74c3c; --roulette-red: #c0392b; --roulette-black: #2c3e50; --roulette-green: #27ae60; --wood-color: #3a2e26; }
        * { box-sizing: border-box; }
        html, body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; height: 100vh; width: 100vw; overflow: hidden; font-size: 15px; }
        #app-container { display: none; flex-direction: row; width: 100%; height: 100%; }
        .sidebar { width: 240px; background-color: var(--primary-color); padding: 15px; display: flex; flex-direction: column; border-right: 1px solid var(--secondary-color); flex-shrink: 0; }
        .main-content { flex-grow: 1; padding: 25px; overflow-y: auto; height: 100%; }
        .chat-sidebar { width: 300px; background-color: var(--primary-color); padding: 15px; display: flex; flex-direction: column; border-left: 1px solid var(--secondary-color); flex-shrink: 0; height: 100%; }
        .logo { font-size: 22px; font-weight: bold; text-align: center; margin-bottom: 25px; color: var(--accent-color); }
        .nav-menu button { display: block; width: 100%; padding: 12px; margin-bottom: 8px; background-color: var(--secondary-color); color: var(--text-color); border: none; border-radius: var(--border-radius); text-align: left; font-size: 15px; cursor: pointer; transition: all 0.2s; }
        .nav-menu button:hover, .nav-menu button.active { background-color: var(--accent-color); color: var(--bg-color); transform: translateY(-2px); box-shadow: 0 2px 8px rgba(255, 255, 255, 0.2); }
        .user-info { margin-top: auto; background-color: var(--secondary-color); padding: 12px; border-radius: var(--border-radius); position: relative; }
        .user-info-header { display: flex; align-items: center; justify-content: space-between; }
        .user-details { display: flex; align-items: center; min-width: 0; }
        .user-info img { width: 38px; height: 38px; border-radius: 50%; margin-right: 10px; object-fit: cover; flex-shrink: 0; }
        #username-display { font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; } 
        #coins-display { font-size: 13px; color: #aaa; }
        #menu-button { background: none; border: none; color: var(--text-color); font-size: 22px; cursor: pointer; }
        .dropdown-menu { display: none; position: absolute; bottom: 60px; right: 12px; background-color: #333; border-radius: var(--border-radius); box-shadow: var(--shadow); overflow: hidden; z-index: 100; width: 140px; border: 1px solid #444; }
        .dropdown-menu a { display: block; padding: 10px 15px; color: var(--text-color); text-decoration: none; transition: background-color 0.2s; font-size: 14px; }
        .dropdown-menu a:hover { background-color: #454545; }
        .tab-content { display: none; } .tab-content.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        h1 { margin-top: 0; padding-bottom: 15px; font-size: 24px; border-bottom: 1px solid var(--secondary-color); }
        h2 { border-bottom: 1px solid var(--secondary-color); padding-bottom: 10px; margin-top: 25px; margin-bottom: 20px; }
        h2:first-of-type { margin-top: 0; }
        .game-container { background-color: var(--primary-color); padding: 20px; border-radius: var(--border-radius); box-shadow: var(--shadow); }
        .game-controls { display: flex; flex-wrap: wrap; gap: 15px; align-items: flex-end; margin-bottom: 20px; background-color: var(--secondary-color); padding: 15px; border-radius: var(--border-radius); }
        .game-controls .form-group { display: flex; flex-direction: column; }
        .game-controls label { font-size: 13px; color: #aaa; margin-bottom: 5px; }
        .game-controls input, .game-controls select { padding: 8px; background-color: var(--bg-color); border: 1px solid #444; border-radius: var(--border-radius); color: var(--text-color); max-width: 140px; font-size: 14px; }
        .custom-button { padding: 9px 18px; background-color: var(--accent-color); color: var(--bg-color); border: none; border-radius: var(--border-radius); cursor: pointer; font-size: 14px; font-weight: bold; transition: all 0.2s; }
        .custom-button:hover { background-color: #e0e0e0; transform: translateY(-1px); }
        .custom-button:disabled { background-color: #555; color: #888; cursor: not-allowed; transform: none; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8); backdrop-filter: blur(5px); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-overlay.hidden { display: none; }
        .modal-content { background-color: var(--primary-color); padding: 25px; border-radius: var(--border-radius); box-shadow: var(--shadow); width: 90%; max-width: 400px; text-align: center; }
        .modal-content input { width: 100%; padding: 11px; margin-bottom: 12px; font-size: 15px; background-color: var(--secondary-color); border: 1px solid #444; border-radius: var(--border-radius); color: var(--text-color); }
        .modal-content .switch-link { color: var(--accent-color); cursor: pointer; text-decoration: underline; margin-top: 15px; display: inline-block; font-size: 14px; }
        .error-message { color: #ff5555; margin-bottom: 15px; min-height: 20px; text-align: left; font-size: 14px; }
        .auth-options { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; font-size: 14px; color: #ccc; padding: 0 5px;}
        .auth-options label { display: flex; align-items: center; cursor: pointer; }
        .auth-options input[type="checkbox"] { margin-right: 8px; }

        /* Roulette Styles */
        #roulette-wrapper { background-color: var(--wood-color); padding: 20px; border-radius: 20px; box-shadow: inset 0 0 15px rgba(0,0,0,0.5); display: flex; gap: 20px; align-items: flex-start; flex-wrap: wrap; }
        .roulette-left { display: flex; flex-direction: column; gap: 15px; align-items: center; }
        .chip-rack { background: rgba(0,0,0,0.2); padding: 10px; border-radius: var(--border-radius); text-align: center; }
        #roulette-wheel-container { position: relative; width: 280px; height: 280px; }
        #roulette-wheel { width: 100%; height: 100%; border-radius: 50%; position: relative; transition: transform 6s cubic-bezier(0.2, .8, .2, 1); }
        .wheel-spinner { position: absolute; top: 50%; left: 50%; width: 50px; height: 50px; background: #c0c0c0; border: 3px solid #888; border-radius: 50%; transform: translate(-50%, -50%); z-index: 4;}
        .wheel-spinner::before, .wheel-spinner::after { content: ''; position: absolute; top: 50%; left: 50%; background: #999; }
        .wheel-spinner::before { width: 5px; height: 40px; margin-left: -2.5px; margin-top: -20px; }
        .wheel-spinner::after { height: 5px; width: 40px; margin-top: -2.5px; margin-left: -20px; }
        .wheel-number { position: absolute; top: 0; left: 0; width: 100%; height: 100%; font-weight: bold; font-size: 14px; color: white; text-shadow: 1px 1px 2px #000; text-align: center; z-index: 3; transform-origin: center center; }
        #roulette-table { flex-grow: 1; background-color: var(--roulette-green); padding: 15px; border-radius: var(--border-radius); box-shadow: inset 0 0 10px rgba(0,0,0,0.4); }
        #roulette-mat { display: grid; grid-template-columns: 50px repeat(12, 1fr) 50px; gap: 4px; }
        .r-cell { display: flex; justify-content: center; align-items: center; font-weight: bold; font-size: 14px; border-radius: 4px; cursor: pointer; transition: all 0.2s; position: relative; border: 1px solid rgba(255,255,255,0.2); color: white; min-height: 40px; }
        .r-cell:hover { background-color: rgba(255,255,255,0.2); }
        .r-cell.red { background-color: var(--roulette-red); } .r-cell.black { background-color: var(--roulette-black); } .r-cell.green { background-color: var(--roulette-green); grid-row: 1 / 4; grid-column: 1 / 2; }
        .r-col { grid-column: 14 / 15; text-align: center; writing-mode: vertical-rl; transform: rotate(180deg); }
        .r-dozen { grid-column: span 4; }
        .r-outside { grid-column: span 2; }
        .r-cell .bet-chip { position: absolute; width: 22px; height: 22px; background-color: #ffeb3b; color: black; font-size: 10px; line-height: 22px; border-radius: 50%; font-weight: bold; text-align: center; box-shadow: 0 0 5px rgba(0,0,0,0.5); display: none; transform: translate(5px, -5px); }
        .r-cell.has-bet .bet-chip { display: block; }
        
        #bj-actions-container { display: flex; justify-content: center; gap: 10px; margin-top: 20px; }
        #mines-info { display: flex; justify-content: space-between; align-items: center; background: var(--secondary-color); padding: 15px; border-radius: var(--border-radius); margin-top: 20px; }
        #mines-info-stats { display: flex; gap: 20px; }
        #mines-info-stats > div { text-align: center; }
        #mines-info-stats span { display: block; font-size: 14px; color: #aaa; }
        #mines-info-stats strong { font-size: 1.2em; }

        .admin-section { margin-bottom: 30px; background-color: var(--secondary-color); padding: 20px; border-radius: var(--border-radius); }
        .admin-section h3 { margin-top: 0; border-bottom: 1px solid #444; padding-bottom: 10px; }
        .admin-form { display: flex; gap: 10px; flex-wrap: wrap; align-items: flex-end; }
        .admin-form input, .admin-form select { background-color: var(--bg-color); border: 1px solid #444; border-radius: var(--border-radius); color: var(--text-color); padding: 8px; font-size: 14px;}
        #not-admin-message h2 { font-size: 1.5em; color: var(--mine-color); text-align: center; }
        #not-admin-message p { text-align: center; color: #aaa; }
    </style>
</head>
<body>
    <div id="auth-modal" class="modal-overlay">
        <div class="modal-content">
            <div id="login-form"><h2>Login</h2><div class="error-message" id="login-error"></div><input type="text" id="login-username" placeholder="Username" required><input type="password" id="login-password" placeholder="Password" required><div class="auth-options"><label for="remember-me"><input type="checkbox" id="remember-me" checked> Remember Session</label></div><button id="login-btn" class="custom-button">Login</button><p>Don't have an account? <span class="switch-link" onclick="toggleAuthForms()">Register here</span></p></div>
            <div id="register-form" style="display: none;"><h2>Register</h2><div class="error-message" id="register-error"></div><input type="text" id="register-username" placeholder="Username" required><input type="password" id="register-password" placeholder="Password (min 4 chars)" required><button id="register-btn" class="custom-button">Register</button><p>Already have an account? <span class="switch-link" onclick="toggleAuthForms()">Login here</span></p></div>
        </div>
    </div>
    <div id="public-profile-modal" class="modal-overlay hidden"><div id="public-profile-content" class="modal-content"></div></div>
    <div id="app-container">
        <aside class="sidebar">
             <div class="logo">Ghosts Gambling</div>
            <nav class="nav-menu"><button class="nav-tab active" data-tab="home">Home</button><button class="nav-tab" data-tab="blackjack">Blackjack</button><button class="nav-tab" data-tab="mines">Mines</button><button class="nav-tab" data-tab="roulette">Roulette</button></nav>
            <div class="user-info">
                <div class="user-info-header"><div class="user-details"><img id="user-pfp-display" src="" alt="PFP"><div><div id="username-display"></div><div id="coins-display"></div></div></div><button id="menu-button">☰</button></div>
                <div class="dropdown-menu" id="dropdown-menu"><a href="#" id="profile-btn">Profile</a><a href="#" id="admin-btn">Admin</a><a href="#" id="logout-btn">Logout</a></div>
            </div>
        </aside>
        <main class="main-content">
            <div id="home-tab" class="tab-content active"><div class="home-container"><div class="developer-block"><a href="https://fakecrime.bio/GhostUD" target="_blank" style="text-decoration:none;"><img src="https://i.imgur.com/8bzvETr.png" alt="Developer PFP"><h2>Developed by Ghost</h2><p>A full-stack gambling application using Node.js, Express, and WebSockets. All balances are virtual coins with no real-world value.</p></a></div></div></div>
            <div id="profile-page" class="tab-content"><h1>Edit Profile</h1><img id="profile-pfp-preview" src=""><div class="form-group"><label for="profile-pfp-upload">Upload New Profile Picture</label><input type="file" id="profile-pfp-upload" accept="image/jpeg, image/png, image/gif"><small>Max 25MB.</small></div><div class="form-group"><label for="profile-bio">Bio</label><textarea id="profile-bio" placeholder="Tell everyone a little about yourself..."></textarea></div><button id="save-profile-btn" class="custom-button">Save Changes</button></div>
            <div id="blackjack-tab" class="tab-content"><div class="game-container"><div class="game-controls"><div class="form-group"><label for="bj-bet-amount">Bet</label><input type="number" id="bj-bet-amount" value="100"></div><button id="bj-start-btn" class="custom-button">Start</button></div><div id="blackjack-game-area" style="display: none;"><div class="hand-container"><h3>Dealer (<span id="dealer-score">0</span>)</h3><div class="cards" id="dealer-cards"></div></div><div class="game-status" id="bj-status"></div><div class="hand-container"><h3>You (<span id="player-score">0</span>)</h3><div class="cards" id="player-cards"></div><div id="bj-actions-container"><button id="bj-hit-btn" class="custom-button">Hit</button><button id="bj-stand-btn" class="custom-button">Stand</button></div></div></div></div></div>
            <div id="mines-tab" class="tab-content"><div class="game-container"><div class="game-controls"><div class="form-group"><label for="mines-bet-amount">Bet</label><input type="number" id="mines-bet-amount" value="100"></div><div class="form-group"><label for="mines-count">Mines</label><select id="mines-count"><option value="3">3</option><option value="5">5</option><option value="8">8</option><option value="10">10</option></select></div><button id="mines-start-btn" class="custom-button">Start</button></div><div id="mines-game-area" style="display: none;"><div class="mines-grid" id="mines-grid"></div><div id="mines-info"><div id="mines-info-stats"><div><span>Profit</span><strong id="mines-profit">0</strong></div><div><span>Next Tile</span><strong id="mines-next-profit">0</strong></div></div><button id="mines-cashout-btn" class="custom-button" disabled>Cashout</button></div></div></div></div>
            <div id="roulette-tab" class="tab-content"><div id="roulette-wrapper"><div class="roulette-left"><div class="chip-rack game-controls"><div class="form-group"><label for="roulette-bet-amount">Bet Amount</label><input type="number" id="roulette-bet-amount" value="100"></div><button id="roulette-spin-btn" class="custom-button">Spin</button><button id="roulette-clear-btn" class="custom-button">Clear Bets</button></div><div id="roulette-wheel-container"><div id="roulette-wheel"><div id="roulette-wheel-bg"></div><div class="wheel-number-container" id="wheel-number-container"></div><div class="wheel-spinner"></div></div></div><div id="roulette-status" style="font-size: 1.4em; font-weight: bold; margin-top: 10px;">Place Your Bets</div></div><div id="roulette-table"><div id="roulette-mat"></div></div></div></div>
            <div id="admin-page" class="tab-content"><h1>Admin Panel</h1><div id="admin-panel-content"><div id="admin-actions-container" style="display: none;"><h2>Admin Actions</h2><div class="admin-section"><h3>Daily Reward</h3><p id="daily-claim-status"></p><button id="claim-daily-btn" class="custom-button">Claim Now</button></div><div class="admin-section"><h3>Chat Moderation</h3><form id="timeout-user-form" class="admin-form"><input type="text" id="timeout-username" list="user-list" placeholder="Username" required><select id="timeout-duration"><option value="0.5">30 Seconds</option><option value="1">1 Minute</option><option value="5">5 Minutes</option><option value="10">10 Minutes</option><option value="30">30 Minutes</option><option value="60">1 Hour</option><option value="360">6 Hours</option><option value="720">12 Hours</option><option value="1440">1 Day</option></select><button type="submit" class="custom-button">Timeout User</button></form></div></div><div id="owner-actions-container" style="display: none;"><h2>Owner Actions</h2><div class="admin-section"><h3>Coin Management</h3><form id="give-coins-form" class="admin-form"><input type="text" id="give-coins-username" list="user-list" placeholder="Username" required><input type="number" id="give-coins-amount" placeholder="Amount" required><button type="submit" class="custom-button">Give Coins</button></form></div><div class="admin-section"><h3>Admin Status</h3><form id="set-admin-form" class="admin-form"><input type="text" id="set-admin-username" list="user-list" placeholder="Username" required><select id="set-admin-status"><option value="true">Make Admin</option><option value="false">Remove Admin</option></select><button type="submit" class="custom-button">Update Status</button></form></div><div class="admin-section"><h3>Global Chat</h3><button id="clear-chat-btn" class="custom-button">Clear Entire Chat</button></div></div><div id="not-admin-message" style="display: none;"><h2>No Access</h2><p>You are not an admin.</p></div></div></div>
        </main>
        <aside class="chat-sidebar"><div class="chat-container"><h3>Online</h3><ul id="online-users-list"></ul></div><div class="chat-container"><h3>Chat</h3><ul id="chat-messages"></ul><form id="chat-form"><input id="chat-input" autocomplete="off" placeholder="Say something..."></form></div></aside>
    </div>
    <datalist id="user-list"></datalist>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            let token = null, socket = null, currentUser = null, newPfpBase64 = null, isMinesGameOver = false, wheelCurrentRotation = 0;
            const $ = s => document.querySelector(s), $$ = s => document.querySelectorAll(s);
            const ROULETTE_NUMBERS_ORDER = [0, 32, 15, 19, 4, 21, 2, 25, 17, 34, 6, 27, 13, 36, 11, 30, 8, 23, 10, 5, 24, 16, 33, 1, 20, 14, 31, 9, 22, 18, 29, 7, 28, 12, 35, 3, 26];
            const ROULETTE_COLORS = { 0: 'green', 1: 'red', 2: 'black', 3: 'red', 4: 'black', 5: 'red', 6: 'black', 7: 'red', 8: 'black', 9: 'red', 10: 'black', 11: 'black', 12: 'red', 13: 'black', 14: 'red', 15: 'black', 16: 'red', 17: 'black', 18: 'red', 19: 'red', 20: 'black', 21: 'red', 22: 'black', 23: 'red', 24: 'black', 25: 'red', 26: 'black', 27: 'red', 28: 'black', 29: 'black', 30: 'red', 31: 'black', 32: 'red', 33: 'black', 34: 'red', 35: 'black', 36: 'red' };
            let rouletteBets = {}, isSpinning = false;
            
            const apiCall = async (endpoint, options = {}) => { options.headers = { ...options.headers, 'Content-Type': 'application/json', 'Accept': 'application/json' }; if (token) options.headers['Authorization'] = `Bearer ${token}`; const response = await fetch(`/api${endpoint}`, options); if (!response.ok) { if (response.status === 401) logout(false); let err; try { const d = await response.json(); err = d.message; } catch (e) { err = await response.text(); } throw new Error(err || 'An unknown error occurred.'); } if (response.status === 204 || response.headers.get("content-length") === "0") return null; return response.json(); };
            window.toggleAuthForms = () => { $('#login-form').style.display = $('#login-form').style.display === 'none' ? 'block' : 'none'; $('#register-form').style.display = $('#register-form').style.display === 'none' ? 'block' : 'none'; $('#login-error').textContent = ''; $('#register-error').textContent = ''; };
            const setupAuthListeners = () => { $('#register-btn').addEventListener('click', async () => { try { const data = await apiCall('/register', { method: 'POST', body: JSON.stringify({ username: $('#register-username').value, password: $('#register-password').value }) }); alert(data.message); toggleAuthForms(); } catch (err) { $('#register-error').textContent = err.message; } }); $('#login-btn').addEventListener('click', async () => { const username = $('#login-username').value, password = $('#login-password').value; try { const data = await apiCall('/login', { method: 'POST', body: JSON.stringify({ username, password }) }); token = data.token; if ($('#remember-me').checked) localStorage.setItem('authToken', token); else sessionStorage.setItem('authToken', token); localStorage.setItem('lastUsername', username); initializeApp(); } catch (err) { $('#login-error').textContent = err.message; } }); $('#logout-btn').addEventListener('click', () => logout(true)); };
            function logout(reload = true) { token = null; currentUser = null; localStorage.removeItem('authToken'); sessionStorage.removeItem('authToken'); if (socket) socket.disconnect(); if (reload) window.location.reload(); else { $('#auth-modal').style.display = 'flex'; $('#app-container').style.display = 'none'; } }
            async function initializeApp() { $('#auth-modal').style.display = 'none'; $('#app-container').style.display = 'flex'; try { await fetchProfile(); setupWebSocket(); setupUIEventListeners(); switchTab('home'); } catch (error) { console.error("Initialization failed:", error.message); logout(false); } }
            const checkForSavedSession = () => { token = localStorage.getItem('authToken') || sessionStorage.getItem('authToken'); const lastUsername = localStorage.getItem('lastUsername'); if (lastUsername) $('#login-username').value = lastUsername; if (token) initializeApp(); else { $('#auth-modal').style.display = 'flex'; setupAuthListeners(); } };
            async function fetchProfile() { try { currentUser = await apiCall('/profile'); updateUserUI(); } catch (err) { console.error("Failed to fetch profile:", err); logout(false); } }
            const updateUserUI = () => { if (!currentUser) return; $('#username-display').textContent = currentUser.username; $('#coins-display').textContent = `${currentUser.coins.toLocaleString()} coins`; $('#user-pfp-display').src = currentUser.pfp; };
            const switchTab = e => { $$('.tab-content').forEach(e => e.classList.remove('active')); $$('.nav-tab').forEach(e => e.classList.remove('active')); const t = $(`#${e}-tab`) || $(`#${e}`); t && t.classList.add('active'); const o = $(`.nav-tab[data-tab="${e}"]`); o && o.classList.add('active'); };
            const loadProfileForEditing = () => { if (!currentUser) return; $('#profile-pfp-preview').src = currentUser.pfp; $('#profile-bio').value = currentUser.bio; newPfpBase64 = null; $('#profile-pfp-upload').value = ''; };
            const handlePfpUpload = e => { const t = e.target.files[0]; if (!t) return; if (t.size > 26214400) return alert("File is too large! Max 25MB."); const o = new FileReader; o.onload = e => { newPfpBase64 = e.target.result; $('#profile-pfp-preview').src = newPfpBase64; }; o.readAsDataURL(t); };
            const saveProfile = async () => { try { const e = { bio: $('#profile-bio').value }; newPfpBase64 && (e.pfp = newPfpBase64); await apiCall('/profile/update', { method: 'POST', body: JSON.stringify(e) }); await fetchProfile(); alert('Profile updated!'); switchTab('home'); } catch (e) { alert(e.message); } };
            const showPublicProfile = async e => { try { const t = await apiCall(`/user/${e}`); $('#public-profile-content').innerHTML = `<img src="${t.pfp}"><h2>${t.username}</h2><div><span>Bio:</span><p>${t.bio || "No bio set."}</p></div><button class="custom-button" onclick="document.getElementById('public-profile-modal').classList.add('hidden')">Close</button>`; $('#public-profile-modal').classList.remove('hidden'); } catch (e) { alert(e.message); } };
            const setupWebSocket = () => { socket && socket.disconnect(); socket = io({ auth: { token } }); socket.on('connect_error', e => { console.error("Socket error:", e.message); logout(false); }); socket.on('online_users', e => { let t = ""; e.sort((e, t) => t.coins - e.coins).forEach(e => { t += `<li data-username="${e.username}"><img src="${e.pfp}"><div><div class="username">${e.username}</div><div class="coins">${e.coins.toLocaleString()} coins</div></div></li>`; }); $('#online-users-list').innerHTML = t; }); socket.on('chat_history', e => { $('#chat-messages').innerHTML = ""; e.forEach(addChatMessage); }); socket.on('chat_message', addChatMessage); socket.on('message_deleted', e => { const t = $(`[data-message-id="${e}"]`); t && t.remove(); }); socket.on('chat_cleared', () => { $('#chat-messages').innerHTML = ""; }); socket.on('chat_error', alert); };
            const addChatMessage = e => { const t = $('#chat-messages'); const o = e.username === currentUser.username; const n = currentUser.isAdmin || currentUser.isOwner || (o && (Date.now() - new Date(e.timestamp).getTime() < 3e5)); const s = n ? `<span class="delete-msg-btn" data-message-id="${e._id}">🗑️</span>` : ""; t.innerHTML += `<li class="message-item" data-message-id="${e._id}"><img src="${e.pfp}"><div class="message-content"><div class="message-header"><span class="message-user" data-username="${e.username}">${e.username}</span><span class="message-timestamp">${new Date(e.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>${s}</div><div>${e.message.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</div></div></li>`; t.scrollTop = t.scrollHeight; };
            const createCardHTML = e => "?" === e.value ? '<div class="card hidden"></div>' : `<div class="card" style="color:${["H","D"].includes(e.suit)?"red":"black"};"><span class="top">${e.value}${{H:"♥",D:"♦",C:"♣",S:"♠"}[e.suit]}</span>${e.value}<span class="bottom">${e.value}${{H:"♥",D:"♦",C:"♣",S:"♠"}[e.suit]}</span></div>`;
            const updateBlackjackUI = e => { if ($("#player-cards").innerHTML = e.playerHand.map(createCardHTML).join(""), $("#dealer-cards").innerHTML = e.dealerHand.map(createCardHTML).join(""), $("#player-score").textContent = e.playerValue, $("#dealer-score").textContent = e.dealerValue || "?", $("#bj-status").textContent = e.status, "undefined" != typeof e.newBalance && (currentUser.coins = e.newBalance, updateUserUI()), "playing" === e.status) { $("#bj-hit-btn").style.display = "inline-block", $("#bj-stand-btn").style.display = "inline-block", $("#bj-start-btn").disabled = !0; } else $("#bj-hit-btn").style.display = "none", $("#bj-stand-btn").style.display = "none", $("#bj-start-btn").disabled = !1; };
            const setupBlackjackListeners = () => { const e = async t => { try { $("#bj-hit-btn").disabled = !0, $("#bj-stand-btn").disabled = !0; const o = await apiCall("/blackjack/action", { method: "POST", body: JSON.stringify({ action: t }) }); updateBlackjackUI(o), $("#bj-hit-btn").disabled = !1, $("#bj-stand-btn").disabled = !1; } catch (e) { alert(e.message); } }; $("#bj-start-btn").addEventListener("click", async () => { try { $("#blackjack-game-area").style.display = "block"; const e = await apiCall("/blackjack/start", { method: "POST", body: JSON.stringify({ bet: parseInt($("#bj-bet-amount").value) }) }); updateBlackjackUI(e); } catch (e) { alert(e.message); } }); $("#bj-hit-btn").addEventListener("click", () => e("hit")); $("#bj-stand-btn").addEventListener("click", () => e("stand")); };
            const setupMinesListeners = () => { startMines = async () => { try { isMinesGameOver = !1; const e = parseInt($("#mines-bet-amount").value), t = parseInt($("#mines-count").value), o = await apiCall("/mines/start", { method: "POST", body: JSON.stringify({ bet: e, minesCount: t }) }); currentUser.coins = o.newBalance, updateUserUI(), renderMinesGrid(), $("#mines-game-area").style.display = "block", $("#mines-start-btn").disabled = !0, $("#mines-cashout-btn").disabled = !0, $("#mines-profit").textContent = "0"; const n = { 3: 1.15, 5: 1.3, 8: 1.5, 10: 1.8 }[t]; $("#mines-next-profit").textContent = `${Math.floor(e * n - e)}`; } catch (e) { alert(e.message); } }, renderMinesGrid = () => { let e = $("#mines-grid"); e.innerHTML = ""; for (let t = 0; t < 25; t++) { const o = document.createElement("div"); o.className = "mine-cell", o.addEventListener("mouseover", e => { isMinesGameOver || e.target.classList.contains("safe") || (e.target.style.backgroundColor = "#444"); }), o.addEventListener("mouseout", e => { e.target.classList.contains("safe") || (e.target.style.backgroundColor = "var(--secondary-color)"); }), o.dataset.index = t, o.addEventListener("click", handleMineClick), e.appendChild(o); } }, handleMineClick = async e => { const t = e.target; if (isMinesGameOver || t.classList.contains("safe")) return; try { const e = await apiCall("/mines/click", { method: "POST", body: JSON.stringify({ index: parseInt(t.dataset.index) }) }); e.gameOver ? (isMinesGameOver = !0, alert(e.message), e.minePositions.forEach(e => $(`.mine-cell[data-index='${e}']`).style.backgroundColor = "var(--mine-color)"), resetMinesGame(!1)) : (t.style.backgroundColor = "var(--safe-color)", t.classList.add("safe"), $("#mines-cashout-btn").disabled = !1, $("#mines-profit").textContent = e.profit, $("#mines-next-profit").textContent = `${Math.floor(parseInt($("#mines-bet-amount").value) * e.nextMultiplier - parseInt($("#mines-bet-amount").value))}`); } catch (e) { alert(e.message), resetMinesGame(!0); } }, cashoutMines = async () => { try { isMinesGameOver = !0; const e = await apiCall("/mines/cashout", { method: "POST" }); alert(e.message), currentUser.coins = e.newBalance, updateUserUI(), resetMinesGame(!0); } catch (e) { alert(e.message); } }, resetMinesGame = e => { $("#mines-start-btn").disabled = !1, $("#mines-cashout-btn").disabled = !0, e && ($("#mines-game-area").style.display = "none"); }, $("#mines-start-btn").addEventListener("click", startMines), $("#mines-cashout-btn").addEventListener("click", cashoutMines); };
            const setupRouletteListeners = () => { createRouletteTable = () => { const e = $("#roulette-mat"); e.innerHTML = ""; const t = document.createElement("div"); t.className = "r-cell green", t.textContent = "0", t.dataset.betType = "number", t.dataset.betValue = "0", t.style.gridRow = "1 / 4", t.style.gridColumn = "1 / 2", e.appendChild(t); for (let t = 1; t <= 36; t++) { const o = document.createElement("div"); o.className = `r-cell r-num ${ROULETTE_COLORS[t]}`, o.textContent = t, o.dataset.betType = "number", o.dataset.betValue = t, o.style.gridRow = (t - 1) % 3 + 1, o.style.gridColumn = Math.ceil(t / 3) + 1, e.appendChild(o) } [{ v: "1st" }, { v: "2nd" }, { v: "3rd" }].forEach((t, o) => { const n = document.createElement("div"); n.className = "r-cell r-col", n.textContent = "2 to 1", n.dataset.betType = "column", n.dataset.betValue = t.v, n.style.gridRow = `${o+1} / ${o+2}`, n.style.gridColumn = "14 / 15", e.appendChild(n) }), [{ l: "1st 12", v: "1st" }, { l: "2nd 12", v: "2nd" }, { l: "3rd 12", v: "3rd" }].forEach((t, o) => { const n = document.createElement("div"); n.className = "r-cell r-dozen", n.textContent = t.l, n.dataset.betType = "dozen", n.dataset.betValue = t.v, n.style.gridRow = "4 / 5", n.style.gridColumn = `${4*o+2} / ${4*o+6}`, e.appendChild(n) }), [{ l: "1-18", t: "range", v: "1-18" }, { l: "EVEN", t: "parity", v: "even" }, { l: "♦", t: "color", v: "red", c: "red" }, { l: "♦", t: "color", v: "black", c: "black" }, { l: "ODD", t: "parity", v: "odd" }, { l: "19-36", t: "range", v: "19-36" }].forEach((t, o) => { const n = document.createElement("div"); n.className = `r-cell r-outside ${t.c||""}`, n.textContent = t.l, n.dataset.betType = t.t, n.dataset.betValue = t.v, n.style.gridRow = "5 / 6", n.style.gridColumn = `${2*o+2} / ${2*o+4}`, e.appendChild(n) }), $$(".r-cell").forEach(e => e.innerHTML += '<span class="bet-chip"></span>') }, createRouletteWheel = () => { const e = $("#roulette-wheel-bg"), t = $("#wheel-number-container"); e.innerHTML = "", t.innerHTML = ""; const o = 360 / ROULETTE_NUMBERS_ORDER.length, n = ROULETTE_NUMBERS_ORDER.map((e, t) => { const n = ROULETTE_COLORS[e]; return `var(--roulette-${n}) ${t*o}deg ${(t+1)*o}deg` }); e.style.background = `conic-gradient(${n.join(", ")})`, ROULETTE_NUMBERS_ORDER.forEach((e, n) => { const s = n * o + o / 2, a = document.createElement("div"); a.className = "wheel-number", a.style.transform = `rotate(${s}deg)`, a.textContent = e, t.appendChild(a) }) }, handleRouletteBet = e => { if (isSpinning) return; const t = e.target.closest(".r-cell"); if (!t || !t.dataset.betType) return; const o = parseInt($("#roulette-bet-amount").value, 10); if (isNaN(o) || o <= 0) return alert("Invalid bet amount."); const { betType: n, betValue: s } = t.dataset; rouletteBets[n] = rouletteBets[n] || {}, rouletteBets[n][s] = (rouletteBets[n][s] || 0) + o, updateRouletteUI() }, updateRouletteUI = () => { let e = 0; $$(".r-cell").forEach(t => { t.classList.remove("has-bet"); const e = t.querySelector(".bet-chip"); e && (e.style.display = "none") }); for (const t in rouletteBets) for (const o in rouletteBets[t]) { const n = rouletteBets[t][o]; e += n; const s = $(`.r-cell[data-bet-type="${t}"][data-bet-value="${o}"]`); if (s) { s.classList.add("has-bet"); const e = s.querySelector(".bet-chip"); e && (e.textContent = n > 999 ? `${Math.floor(n/1e3)}k` : n, e.style.display = "block") } } $("#roulette-spin-btn").disabled = 0 === e || isSpinning }, clearRouletteBets = () => { if (isSpinning) return; rouletteBets = {}, $("#roulette-status").textContent = "Place your bets!", $("#roulette-status").style.color = "var(--accent-color)", updateRouletteUI() }, spinRouletteWheel = async () => { if (isSpinning || 0 === Object.keys(rouletteBets).length) return; isSpinning = !0, updateRouletteUI(), $("#roulette-status").textContent = "Spinning...", $("#roulette-status").style.color = "var(--accent-color)"; try { const e = await apiCall("/roulette/spin", { method: "POST", body: JSON.stringify({ bets: rouletteBets }) }), { winningNumber: t, winnings: o, newBalance: n, message: s } = e, a = $("#roulette-wheel"), r = ROULETTE_NUMBERS_ORDER.indexOf(t), i = 360 / ROULETTE_NUMBERS_ORDER.length, l = -(r * i) - i / 2; wheelCurrentRotation = wheelCurrentRotation - wheelCurrentRotation % 360 + 3600 + l + 4 * Math.random() - 2, a.style.transform = `rotate(${wheelCurrentRotation}deg)`, setTimeout(() => { isSpinning = !1, currentUser.coins = n, updateUserUI(), $("#roulette-status").textContent = s, $("#roulette-status").style.color = o > 0 ? "var(--safe-color)" : "var(--mine-color)", clearRouletteBets() }, 6100); } catch (e) { alert(e.message), isSpinning = !1, clearRouletteBets(), updateRouletteUI(); } }, createRouletteTable(), createRouletteWheel(), $("#roulette-table").addEventListener("click", handleRouletteBet), $("#roulette-clear-btn").addEventListener("click", clearRouletteBets), $("#roulette-spin-btn").addEventListener("click", spinRouletteWheel); };
            async function loadAdminPanel(){if(!currentUser)return;const e=currentUser.isAdmin,t=currentUser.isOwner;if(!e&&!t)return $("#admin-actions-container").style.display="none",$("#owner-actions-container").style.display="none",void($("#not-admin-message").style.display="block");try{const e=await apiCall("/admin/get-users"),t=$("#user-list");t.innerHTML="",e.forEach(e=>{const o=document.createElement("option");o.value=e,t.appendChild(o)})}catch(e){console.error("Could not load user list for admin panel")}$("#not-admin-message").style.display="none",$("#admin-actions-container").style.display="block",t?($("#owner-actions-container").style.display="block",$("#clear-chat-btn").style.display="inline-block"):($("#owner-actions-container").style.display="none",$("#clear-chat-btn").style.display="none");const o=864e5,n=new Date(currentUser.lastDailyClaim);currentUser.lastDailyClaim&&new Date-n<o?($("#daily-claim-status").textContent=`Next claim in ${Math.ceil((o-(new Date-n))/36e5)} hours.`,$("#claim-daily-btn").disabled=!0):($("#daily-claim-status").textContent="You can claim your daily 100,000 coins.",$("#claim-daily-btn").disabled=!1)}
            const setupAdminListeners = () => { $('#claim-daily-btn').addEventListener('click', async () => { try { const data = await apiCall('/admin/claim-daily', { method: 'POST' }); alert(data.message); currentUser.coins = data.newBalance; currentUser.lastDailyClaim = data.lastDailyClaim; updateUserUI(); loadAdminPanel(); } catch (error) { alert(error.message); } }); $('#clear-chat-btn').addEventListener('click', async () => { if (confirm('Are you sure you want to delete ALL chat messages permanently?')) { try { const data = await apiCall('/owner/clear-chat', { method: 'POST' }); alert(data.message); } catch (error) { alert(error.message); } } }); $('#timeout-user-form').addEventListener('submit', async (e) => { e.preventDefault(); const username = $('#timeout-username').value, duration = $('#timeout-duration').value; try { const data = await apiCall('/admin/timeout-user', { method: 'POST', body: JSON.stringify({ username, duration }) }); alert(data.message); $('#timeout-username').value = ''; } catch (error) { alert(error.message); } }); $('#give-coins-form').addEventListener('submit', async (e) => { e.preventDefault(); const username = $('#give-coins-username').value, amount = $('#give-coins-amount').value; try { const data = await apiCall('/owner/give-coins', { method: 'POST', body: JSON.stringify({ username, amount }) }); alert(data.message); $('#give-coins-username').value = ''; $('#give-coins-amount').value = ''; } catch (error) { alert(error.message); } }); $('#set-admin-form').addEventListener('submit', async (e) => { e.preventDefault(); const username = $('#set-admin-username').value, isAdmin = $('#set-admin-status').value === 'true'; try { const data = await apiCall('/owner/set-admin', { method: 'POST', body: JSON.stringify({ username, isAdmin }) }); alert(data.message); $('#set-admin-username').value = ''; } catch (error) { alert(error.message); } }); };
            
            const setupUIEventListeners = () => {
                $$('.nav-tab').forEach(b => b.addEventListener('click', () => switchTab(b.dataset.tab)));
                $('#menu-button').addEventListener('click', (e) => { e.stopPropagation(); $('#dropdown-menu').style.display = $('#dropdown-menu').style.display === 'block' ? 'none' : 'block'; });
                document.addEventListener('click', () => { $('#dropdown-menu').style.display = 'none'; });
                $('#profile-btn').addEventListener('click', e => { e.preventDefault(); switchTab('profile-page'); loadProfileForEditing(); });
                $('#admin-btn').addEventListener('click', e => { e.preventDefault(); switchTab('admin-page'); loadAdminPanel(); });
                $('#save-profile-btn').addEventListener('click', saveProfile);
                const eventDelegate = (c, e, s, h) => { c.addEventListener(e, ev => { if (ev.target.closest(s)) h(ev, ev.target.closest(s)) }) };
                eventDelegate($('#chat-messages'), 'click', '.message-user', (e, el) => showPublicProfile(el.dataset.username));
                eventDelegate($('#chat-messages'), 'click', '.delete-msg-btn', (e, el) => socket.emit('delete_message', el.dataset.messageId));
                eventDelegate($('#online-users-list'), 'click', 'li', (e, el) => showPublicProfile(el.dataset.username));
                $('#public-profile-modal').addEventListener('click', e => { if (e.target.id === 'public-profile-modal') e.target.classList.add('hidden') });
                $('#profile-pfp-upload').addEventListener('change', handlePfpUpload);
                $('#chat-form').addEventListener('submit', e => { e.preventDefault(); if ($('#chat-input').value) { socket.emit('chat_message', $('#chat-input').value); $('#chat-input').value = ''; } });
                setupBlackjackListeners();
                setupMinesListeners();
                setupRouletteListeners();
                setupAdminListeners();
            };

            checkForSavedSession();
        });
    </script>
</body>
</html>